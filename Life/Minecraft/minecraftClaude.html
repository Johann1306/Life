<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{overflow:hidden;background:#000;font-family:Arial,sans-serif}
    #game{width:100vw;height:100vh;display:block}
    #crosshair{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:24px;pointer-events:none;text-shadow:0 0 2px #000}
    #hotbar{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);display:flex;gap:4px;background:rgba(0,0,0,0.5);padding:8px;border-radius:4px}
    .slot{width:50px;height:50px;border:2px solid #555;display:flex;align-items:center;justify-content:center;font-size:10px;color:#fff;cursor:pointer;border-radius:4px}
    .slot.active{border-color:#fff;box-shadow:0 0 10px #fff}
    #instructions{position:fixed;top:10px;left:10px;color:#fff;font-size:12px;background:rgba(0,0,0,0.7);padding:10px;border-radius:4px;max-width:250px}
    #fps{position:fixed;top:10px;right:10px;color:#fff;font-size:12px;background:rgba(0,0,0,0.7);padding:5px 10px;border-radius:4px}
  </style>
</head>
<body>
  <canvas id="game"></canvas>
  <div id="crosshair">+</div>
  <div id="hotbar"></div>
  <div id="instructions">
    <b>Contrôles:</b><br>
    ZQSD/Flèches - Déplacer<br>
    Espace - Sauter<br>
    Souris - Regarder<br>
    Clic gauche - Casser<br>
    Clic droit - Placer<br>
    1-6 - Sélectionner bloc<br>
    Cliquez pour commencer
  </div>
  <div id="fps">FPS: 0</div>

  <script>
    const canvas=document.getElementById('game'),ctx=canvas.getContext('2d');
    let W,H;
    function resize(){W=canvas.width=window.innerWidth;H=canvas.height=window.innerHeight}
    resize();window.onresize=resize;

    const BLOCKS={
      0:{name:'Air',color:null},
      1:{name:'Terre',color:'#8B4513',top:'#8B4513'},
      2:{name:'Herbe',color:'#8B4513',top:'#228B22'},
      3:{name:'Pierre',color:'#808080',top:'#808080'},
      4:{name:'Bois',color:'#DEB887',top:'#DEB887'},
      5:{name:'Feuilles',color:'#006400',top:'#006400'},
      6:{name:'Sable',color:'#F4A460',top:'#F4A460'}
    };

    const WORLD_SIZE=32,WORLD_HEIGHT=24;
    let world=[];
    
    function initWorld(){
      world=[];
      for(let x=0;x<WORLD_SIZE;x++){
        world[x]=[];
        for(let y=0;y<WORLD_HEIGHT;y++){
          world[x][y]=[];
          for(let z=0;z<WORLD_SIZE;z++){
            let h=Math.floor(8+Math.sin(x*0.2)*2+Math.cos(z*0.2)*2+Math.sin((x+z)*0.1)*3);
            if(y<h-3)world[x][y][z]=3;
            else if(y<h-1)world[x][y][z]=1;
            else if(y<h)world[x][y][z]=2;
            else world[x][y][z]=0;
          }
        }
      }
      for(let i=0;i<8;i++){
        let tx=Math.floor(Math.random()*(WORLD_SIZE-4))+2;
        let tz=Math.floor(Math.random()*(WORLD_SIZE-4))+2;
        let ty=0;
        for(let y=WORLD_HEIGHT-1;y>=0;y--)if(world[tx][y][tz]!==0){ty=y+1;break}
        let th=4+Math.floor(Math.random()*3);
        for(let y=0;y<th;y++)if(ty+y<WORLD_HEIGHT)world[tx][ty+y][tz]=4;
        for(let dx=-2;dx<=2;dx++)for(let dy=-1;dy<=2;dy++)for(let dz=-2;dz<=2;dz++){
          let nx=tx+dx,ny=ty+th+dy,nz=tz+dz;
          if(nx>=0&&nx<WORLD_SIZE&&ny>=0&&ny<WORLD_HEIGHT&&nz>=0&&nz<WORLD_SIZE&&Math.abs(dx)+Math.abs(dy)+Math.abs(dz)<4)
            if(world[nx][ny][nz]===0)world[nx][ny][nz]=5;
        }
      }
    }

    let player={x:WORLD_SIZE/2,y:15,z:WORLD_SIZE/2,vx:0,vy:0,vz:0,yaw:0,pitch:0,grounded:false};
    let selectedBlock=2,keys={},locked=false;
    let lastTime=performance.now(),fps=0,frameCount=0,fpsTime=0;

    function getBlock(x,y,z){
      x=Math.floor(x);y=Math.floor(y);z=Math.floor(z);
      if(x<0||x>=WORLD_SIZE||y<0||y>=WORLD_HEIGHT||z<0||z>=WORLD_SIZE)return y<0?1:0;
      return world[x][y][z];
    }

    function setBlock(x,y,z,type){
      x=Math.floor(x);y=Math.floor(y);z=Math.floor(z);
      if(x<0||x>=WORLD_SIZE||y<0||y>=WORLD_HEIGHT||z<0||z>=WORLD_SIZE)return;
      world[x][y][z]=type;
    }

    function collides(x,y,z,w=0.3,h=1.7){
      for(let dx=-w;dx<=w;dx+=w)for(let dy=0;dy<h;dy+=0.5)for(let dz=-w;dz<=w;dz+=w)
        if(getBlock(x+dx,y+dy,z+dz)!==0)return true;
      return false;
    }

    function raycast(maxDist=5){
      let dx=Math.sin(player.yaw)*Math.cos(player.pitch);
      let dy=-Math.sin(player.pitch);
      let dz=Math.cos(player.yaw)*Math.cos(player.pitch);
      let x=player.x,y=player.y+1.5,z=player.z;
      let px=x,py=y,pz=z;
      for(let i=0;i<maxDist*20;i++){
        x+=dx*0.05;y+=dy*0.05;z+=dz*0.05;
        if(getBlock(x,y,z)!==0)return{hit:true,x:Math.floor(x),y:Math.floor(y),z:Math.floor(z),px:Math.floor(px),py:Math.floor(py),pz:Math.floor(pz)};
        px=x;py=y;pz=z;
      }
      return{hit:false};
    }

    function updateHotbar(){
      const hotbar=document.getElementById('hotbar');
      hotbar.innerHTML='';
      for(let i=1;i<=6;i++){
        const slot=document.createElement('div');
        slot.className='slot'+(selectedBlock===i?' active':'');
        slot.style.background=BLOCKS[i].top;
        slot.innerHTML=`<span style="background:rgba(0,0,0,0.5);padding:2px;border-radius:2px">${BLOCKS[i].name}</span>`;
        slot.onclick=()=>{selectedBlock=i;updateHotbar()};
        hotbar.appendChild(slot);
      }
    }

    canvas.onclick=()=>{if(!locked)canvas.requestPointerLock()};
    document.addEventListener('pointerlockchange',()=>{locked=!!document.pointerLockElement});
    document.onmousemove=e=>{
      if(!locked)return;
      player.yaw+=e.movementX*0.002;
      player.pitch+=e.movementY*0.002;
      player.pitch=Math.max(-Math.PI/2+0.1,Math.min(Math.PI/2-0.1,player.pitch));
    };
    document.onkeydown=e=>{keys[e.code]=true;if(e.code.startsWith('Digit')){let n=parseInt(e.code[5]);if(n>=1&&n<=6){selectedBlock=n;updateHotbar()}}};
    document.onkeyup=e=>keys[e.code]=false;
    canvas.onmousedown=e=>{
      if(!locked)return;
      const r=raycast();
      if(e.button===0&&r.hit)setBlock(r.x,r.y,r.z,0);
      else if(e.button===2&&r.hit){
        let px=r.px,py=r.py,pz=r.pz;
        if(!collides(player.x,player.y,player.z)||!(Math.floor(player.x)===px&&(Math.floor(player.y)===py||Math.floor(player.y+1)===py)&&Math.floor(player.z)===pz))
          setBlock(px,py,pz,selectedBlock);
      }
    };
    canvas.oncontextmenu=e=>e.preventDefault();

    function update(dt){
      let speed=5*dt,jump=8;
      let mx=0,mz=0;
      if(keys['KeyW']||keys['ArrowUp'])mz+=1;
      if(keys['KeyS']||keys['ArrowDown'])mz-=1;
      if(keys['KeyA']||keys['ArrowLeft'])mx-=1;
      if(keys['KeyD']||keys['ArrowRight'])mx+=1;
      if(mx||mz){
        let len=Math.sqrt(mx*mx+mz*mz);
        mx/=len;mz/=len;
        let sin=Math.sin(player.yaw),cos=Math.cos(player.yaw);
        player.vx=(mx*cos+mz*sin)*speed/dt;
        player.vz=(-mx*sin+mz*cos)*speed/dt;
      }else{player.vx*=0.8;player.vz*=0.8}
      if(keys['Space']&&player.grounded)player.vy=jump;
      player.vy-=20*dt;
      let nx=player.x+player.vx*dt;
      let ny=player.y+player.vy*dt;
      let nz=player.z+player.vz*dt;
      if(!collides(nx,player.y,player.z))player.x=nx;else player.vx=0;
      if(!collides(player.x,player.y,nz))player.z=nz;else player.vz=0;
      player.grounded=false;
      if(!collides(player.x,ny,player.z))player.y=ny;
      else{if(player.vy<0)player.grounded=true;player.vy=0}
      if(player.y<-10){player.y=20;player.vy=0}
    }

    function render(){
      ctx.fillStyle='#87CEEB';ctx.fillRect(0,0,W,H);
      ctx.fillStyle='#228B22';ctx.fillRect(0,H/2,W,H/2);
      
      let blocks=[];
      let sin=Math.sin(player.yaw),cos=Math.cos(player.yaw);
      let sp=Math.sin(player.pitch),cp=Math.cos(player.pitch);
      
      for(let x=0;x<WORLD_SIZE;x++)for(let y=0;y<WORLD_HEIGHT;y++)for(let z=0;z<WORLD_SIZE;z++){
        if(world[x][y][z]===0)continue;
        let dx=x+0.5-player.x,dy=y+0.5-player.y-1.5,dz=z+0.5-player.z;
        let rx=dx*cos-dz*sin;
        let rz=dx*sin+dz*cos;
        let ry=dy*cp+rz*sp;
        rz=-dy*sp+rz*cp;
        if(rz<0.5||rz>30)continue;
        let exposed=false;
        if(getBlock(x-1,y,z)===0||getBlock(x+1,y,z)===0||getBlock(x,y-1,z)===0||getBlock(x,y+1,z)===0||getBlock(x,y,z-1)===0||getBlock(x,y,z+1)===0)exposed=true;
        if(!exposed)continue;
        blocks.push({x,y,z,rx,ry,rz,dist:rz,type:world[x][y][z]});
      }
      
      blocks.sort((a,b)=>b.dist-a.dist);
      let fov=500;
      
      for(let b of blocks){
        let sx=W/2+b.rx/b.rz*fov;
        let sy=H/2+b.ry/b.rz*fov;
        let size=1/b.rz*fov;
        if(sx<-size||sx>W+size||sy<-size||sy>H+size)continue;
        
        let block=BLOCKS[b.type];
        let shade=Math.max(0.4,1-b.dist/25);
        
        let topVisible=b.y+0.5-player.y-1.5>0;
        
        ctx.fillStyle=shadeColor(topVisible?block.top:block.color,shade);
        ctx.fillRect(sx-size/2,sy-size/2,size,size);
        
        ctx.strokeStyle='rgba(0,0,0,0.2)';
        ctx.lineWidth=1;
        ctx.strokeRect(sx-size/2,sy-size/2,size,size);
      }
      
      const r=raycast();
      if(r.hit){
        let dx=r.x+0.5-player.x,dy=r.y+0.5-player.y-1.5,dz=r.z+0.5-player.z;
        let rx=dx*cos-dz*sin;
        let rz=dx*sin+dz*cos;
        let ry=dy*cp+rz*sp;
        rz=-dy*sp+rz*cp;
        if(rz>0.5){
          let sx=W/2+rx/rz*fov;
          let sy=H/2+ry/rz*fov;
          let size=1/rz*fov;
          ctx.strokeStyle='#fff';ctx.lineWidth=2;
          ctx.strokeRect(sx-size/2-2,sy-size/2-2,size+4,size+4);
        }
      }
    }

    function shadeColor(color,shade){
      let r=parseInt(color.slice(1,3),16);
      let g=parseInt(color.slice(3,5),16);
      let b=parseInt(color.slice(5,7),16);
      r=Math.floor(r*shade);g=Math.floor(g*shade);b=Math.floor(b*shade);
      return`rgb(${r},${g},${b})`;
    }

    function loop(){
      let now=performance.now();
      let dt=Math.min((now-lastTime)/1000,0.1);
      lastTime=now;
      frameCount++;
      if(now-fpsTime>=1000){fps=frameCount;frameCount=0;fpsTime=now;document.getElementById('fps').textContent=`FPS: ${fps}`}
      if(locked)update(dt);
      render();
      requestAnimationFrame(loop);
    }

    initWorld();
    updateHotbar();
    loop();
  </script>
</body>
</html>